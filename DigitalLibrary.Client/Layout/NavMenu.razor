@using DigitalLibrary.Client.Services
@inject NavigationManager Navigation
@inject UserServices UserService
@using Microsoft.AspNetCore.Components.Routing
@using System.IdentityModel.Tokens.Jwt
@inject UserManagementServices UserManagement
@inject UserServices UserServices


<nav class="navbar">
    <ul class="d-flex list-unstyled mb-0">
        <li><NavLink href="/" Match="NavLinkMatch.All">🏠 Trang chủ</NavLink></li>
        <li><NavLink href="/about">📒 Giới thiệu</NavLink></li>
    </ul>

    <ul class="list-unstyled mb-0">
        @if (isLoggedIn)
        {
            <div class="user-menu">
                <img src="@ImageBase64" alt="Avatar" class="avatar" />
                <div class="dropdown-menu">
                    <NavLink href="/profile">⚙️ Trang cá nhân</NavLink>
                    <NavLink href="/subsplans">💳 Gói đăng ký</NavLink>
                    <a href="#" @onclick="Logout">🚪 Đăng xuất</a>
                </div>
            </div>
        }
        else
        {
            <li @onclick="ShowLoginForm"><NavLink href="#">🔑 Đăng nhập</NavLink></li>
        }
    </ul>
</nav>

@if (isLoginFormVisible)
{
    <DigitalLibrary.Client.Pages.LoginForm OnClose="CloseLoginForm" />
}


@code {
    private bool isLoggedIn = false;
    private bool isLoginFormVisible = false;
    private string? ImageBase64;

    private void ShowLoginForm()
    {
        isLoginFormVisible = true;
    }

    protected override async Task OnInitializedAsync()
    {
        isLoggedIn = await UserService.IsLoggedIn();

        if (isLoggedIn)
        {
            var token = await UserService.GetToken();
            var handler = new JwtSecurityTokenHandler();
            var jwtToken = handler.ReadJwtToken(token);
            var userId = jwtToken.Claims.FirstOrDefault(claim => claim.Type == "nameid")!.Value;

            ImageBase64 = await UserManagement.GetImageAsync(int.Parse(userId));
        }
    }

    private void CloseLoginForm()
    {
        isLoginFormVisible = false;
    }

    private async Task Logout()
    {
        await UserService.LogoutAsync();
        isLoggedIn = false;
        Navigation.NavigateTo("/", forceLoad: true);
    }
}

<style>
    .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #faf9f5;
        padding: 10px 20px;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1000;
    }

        .navbar a {
            text-decoration: none;
            color: #000000;
            font-weight: bold;
        }

        .navbar ul {
            display: flex;
            gap: 20px; /* Khoảng cách giữa các mục */
            padding: 0;
            list-style: none;
            margin: 0;
            align-items: center;
        }

            .navbar ul:first-child {
                margin-left: 60px;
            }

            .navbar ul:last-child {
                margin-right: 60px;
            }

    .user-menu {
        position: relative;
        display: inline-block;
    }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        object-fit: cover;
        border: 2px solid #ccc;
        transition: border-color 0.3s;
    }

        .avatar:hover {
            border-color: #007bff;
        }

    .dropdown-menu {
        display: none;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        min-width: 150px;
        overflow: hidden;
        z-index: 1000;
    }

    .user-menu:hover .dropdown-menu {
        display: block;
    }

    .dropdown-menu a {
        display: block;
        padding: 10px;
        color: black;
        text-decoration: none;
        transition: background 0.2s;
    }

        .dropdown-menu a:hover {
            background: #f1f1f1;
        }

</style>